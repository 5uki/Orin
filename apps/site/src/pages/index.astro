---
/**
 * Homepage (L1 Entry Layer)
 *
 * Three-column layout: sidebar (1/4) + posts (1/2) + groups/tags (1/4).
 * Responsive: stacks vertically on mobile.
 *
 * Delegates data fetching to Coordinator Layer (L2).
 * Delegates UI composition to Molecular Layer (L3).
 *
 * Requirements: 2.1, 2.3, 2.4
 */
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getHomePageData } from '@/coordinators';
import { tagToSlug, groupToSlug, getGroupDisplayName } from '@/molecules/taxonomy';
import PostCard from '@/molecules/post/PostCard.astro';
import Sidebar from '@/molecules/sidebar/Sidebar.astro';

// Delegate data fetching to coordinator
const apiBase = import.meta.env.PUBLIC_API_URL || '';
const siteDescription = import.meta.env.PUBLIC_SITE_DESCRIPTION || 'Share tech, development, and life.';

const { latestPosts, tagCounts, groupCounts, sidebarConfig, totalPosts } = await getHomePageData({
  apiBase,
  siteDescription,
  maxLatestPosts: 10,
  maxTags: 100, // Get all tags, we'll slice later
});

// Limit groups to top 5 by post count, tags to top 25
const displayGroups = groupCounts.slice(0, 5);
const displayTags = tagCounts.slice(0, 25);
const hasMoreGroups = groupCounts.length > 5;
const hasMoreTags = tagCounts.length > 25;
---

<BaseLayout title="首页" description="欢迎来到我的博客，分享技术、开发与生活的点滴思考。">
  <div class="home-container">
    <div class="home-layout">
      <div class="home-header-row">
        <div class="home-header-bar">
          <h2 class="section-title">最新文章</h2>
        </div>
      </div>
      <!-- 左侧边栏: 博主信息 (1/4 宽度) -->
      <Sidebar
        avatar={sidebarConfig.ownerAvatar}
        name={sidebarConfig.ownerName}
        description={sidebarConfig.description}
        class="home-sidebar"
      />

      <!-- 中间内容区: 文章列表 (1/2 宽度) -->
      <main class="main-content">
        <section class="posts-section">
          {latestPosts.length > 0 ? (
            <div class="posts-grid">
              {latestPosts.map((post) => (
                <PostCard
                  slug={post.id}
                  title={post.title}
                  date={post.date}
                  updatedDate={post.updatedDate}
                  summary={post.summary}
                  tags={post.tags}
                  isPinned={false}
                  group={post.group}
                />
              ))}
            </div>
          ) : (
            <p class="no-posts">暂无文章，敬请期待！</p>
          )}
          
          {totalPosts > latestPosts.length && (
            <a href="/archive" class="view-all">
              查看全部文章 →
            </a>
          )}
        </section>
      </main>

      <!-- 右侧边栏: 分组和标签 (1/4 宽度) -->
      <aside class="right-sidebar">
        <!-- 分组 -->
        {groupCounts.length > 0 && (
          <div class="widget">
            <div class="widget-header">
              <h3 class="widget-title">分组</h3>
              {hasMoreGroups && (
                <a href="/groups" class="widget-more">全部 →</a>
              )}
            </div>
            <ul class="group-list">
              {displayGroups.map(([group, count]) => (
                <li>
                  <a href={`/groups/${groupToSlug(group)}`} class="group-item">
                    <span class="group-name">{getGroupDisplayName(group)}</span>
                    <span class="group-count">{count}</span>
                  </a>
                </li>
              ))}
            </ul>
          </div>
        )}

        <!-- 标签 -->
        {tagCounts.length > 0 && (
          <div class="widget">
            <div class="widget-header">
              <h3 class="widget-title">标签</h3>
              {hasMoreTags && (
                <a href="/tags" class="widget-more">全部 →</a>
              )}
            </div>
            <div class="tag-list">
              {displayTags.map(([tag, count]) => (
                <a href={`/tags/${tagToSlug(tag)}`} class="tag-item">
                  <span class="tag-name">{tag}</span>
                  <span class="tag-count">{count}</span>
                </a>
              ))}
            </div>
          </div>
        )}
      </aside>
    </div>
  </div>
</BaseLayout>

<script define:vars={{ apiBase }}>
  const badgeSvg = `
    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
      <path d="M16 12V4h1V2H7v2h1v8l-2 2v2h5.2v6h1.6v-6H18v-2l-2-2z"/>
    </svg>
    <span>置顶</span>
  `

  fetch(`${apiBase}/api/posts/pinned`)
    .then((res) => (res.ok ? res.json() : null))
    .then((payload) => {
      if (!payload || !payload.data || !Array.isArray(payload.data)) return
      const pinnedSlugs = new Set(payload.data.map((item) => item.slug))
      const cards = document.querySelectorAll('[data-post-slug]')
      cards.forEach((card) => {
        const slug = card.getAttribute('data-post-slug')
        if (!slug || !pinnedSlugs.has(slug)) return
        card.classList.add('pinned')
        if (!card.querySelector('.pinned-badge')) {
          const badge = document.createElement('div')
          badge.className = 'pinned-badge'
          badge.innerHTML = badgeSvg
          card.insertBefore(badge, card.firstChild)
        }
      })
    })
    .catch(() => {})
</script>

<style>
  .home-container {
    width: 100%;
    max-width: none;
    padding: 0 var(--space-6);
    --home-gutter: var(--space-6);
  }

  .home-layout {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-6);
    padding: var(--space-8) 0;
    --home-sidebar-top: calc(
      var(--header-height) + var(--space-6) + var(--space-6) + var(--space-8)
    );
    --home-sidebar-left: var(--home-gutter);
  }

  /* 桌面端: 1:2:1 布局 */
  @media (min-width: 1024px) {
    .home-layout {
      grid-template-columns: 1fr 2fr 1fr;
      gap: var(--space-8);
      align-items: start;
      grid-template-areas:
        "header header header"
        "sidebar main right";
      --home-column-gap: var(--space-8);
      --home-sidebar-width: calc(
        (100vw - (2 * var(--home-gutter)) - (2 * var(--home-column-gap))) / 4
      );
    }
  }

  /* 平板端: 1:2 布局，右侧栏隐藏 */
  @media (min-width: 768px) and (max-width: 1023px) {
    .home-layout {
      grid-template-columns: 1fr 2fr;
      gap: var(--space-6);
      grid-template-areas:
        "header header"
        "sidebar main";
    }

    .right-sidebar {
      display: none;
    }
  }

  .main-content {
    min-width: 0;
  }

  .home-header-row {
    grid-column: 1 / -1;
    grid-row: 1;
    display: grid;
    grid-template-columns: inherit;
    gap: inherit;
    align-items: end;
    margin-bottom: var(--space-6);
  }

  .home-header-bar {
    grid-column: 2 / -1;
    padding-bottom: var(--space-4);
    border-bottom: none;
  }

  .section-title {
    font-size: var(--text-xl);
    font-weight: var(--font-semibold);
    margin: 0;
    color: var(--color-fg);
  }

  .posts-grid {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .no-posts {
    color: var(--color-fg-muted);
    font-style: italic;
    text-align: center;
    padding: var(--space-8);
  }

  .view-all {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    margin-top: var(--space-6);
    padding: var(--space-2) var(--space-4);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--color-accent);
    background: var(--color-accent-light);
    border-radius: var(--radius-full);
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  .view-all:hover {
    background: var(--color-accent);
    color: white;
  }

  /* 右侧边栏 */
  .right-sidebar {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
  }

  .widget {
    position: relative;
    padding: var(--space-5);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-border-light);
    box-shadow: var(--shadow-sm);
    transition: box-shadow var(--transition-fast);
  }

  .widget:hover {
    box-shadow: var(--shadow-md);
  }

  .widget-title {
    position: relative;
    z-index: 1;
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    color: var(--color-fg-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0;
  }

  .widget-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-4);
  }

  .widget-more {
    font-size: var(--text-xs);
    color: var(--color-accent);
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .widget-more:hover {
    color: var(--color-accent-hover);
  }

  /* 分组列表 */
  .group-list {
    position: relative;
    z-index: 1;
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .group-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-2) var(--space-3);
    background: var(--color-bg);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
    color: var(--color-fg-secondary);
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  .group-item:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
    transform: translateX(2px);
  }

  .group-name {
    font-weight: var(--font-medium);
  }

  .group-count {
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    color: var(--color-accent);
    background: var(--color-accent-light);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-full);
    min-width: 20px;
    text-align: center;
  }

  /* 标签列表 */
  .tag-list {
    position: relative;
    z-index: 1;
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }

  .tag-item {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-1) var(--space-3);
    background: var(--color-accent-light);
    border: 1px solid transparent;
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
    color: var(--color-accent);
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  .tag-item:hover {
    background: var(--color-accent);
    color: white;
  }

  .tag-name {
    font-weight: var(--font-medium);
  }

  .tag-count {
    font-size: var(--text-xs);
    opacity: 0.7;
  }

  /* 移动端: 右侧栏显示在底部 */
  @media (max-width: 767px) {
    .right-sidebar {
      order: 3;
    }

    .home-layout {
      grid-template-areas:
        "header"
        "main"
        "sidebar"
        "right";
    }

    .home-header-bar {
      grid-column: 1;
    }
  }

  .home-header-row {
    grid-area: header;
  }

  .home-sidebar {
    grid-area: sidebar;
  }

  .main-content {
    grid-area: main;
  }

  .right-sidebar {
    grid-area: right;
  }
</style>
